<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal - Control Panel</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0e14;
            --bg-light: #141920;
            --bg-lighter: #1a1f29;
            --border: #1f2430;
            --text: #c5c8c6;
            --text-dim: #6c7680;
            --accent: #00ff9f;
            --accent-dim: #00cc7f;
            --red: #ff3333;
            --yellow: #ffb454;
            --blue: #59c2ff;
            --purple: #c678dd;
        }

        [x-cloak] { display: none !important; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Terminal Header */
        .header {
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .prompt {
            color: var(--accent);
            font-weight: 600;
        }

        .prompt-path {
            color: var(--blue);
        }

        .header-nav {
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            padding: 6px 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--accent);
            background: var(--bg-lighter);
        }

        .tab-btn.active {
            color: var(--accent);
            border-color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 11px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
        }

        .dot.offline { background: var(--red); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .dot.pulse { animation: pulse 2s infinite; }

        /* Main Layout */
        .main {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* System Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            padding: 12px 16px;
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .stat-bar {
            height: 2px;
            background: var(--bg);
            border-radius: 1px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.5s ease;
        }

        /* Terminal Panel */
        .panel {
            background: var(--bg-light);
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .panel-header {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title i {
            color: var(--accent);
            font-size: 11px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 10px;
            background: var(--bg);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .panel-body {
            padding: 16px;
        }

        /* Grid Layouts */
        .grid-3 {
            display: grid;
            grid-template-columns: 280px 1fr 1fr;
            gap: 16px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .btn-primary:hover {
            background: var(--accent-dim);
            border-color: var(--accent-dim);
        }

        .btn-danger {
            border-color: var(--red);
            color: var(--red);
        }

        .btn-danger:hover {
            background: var(--red);
            color: var(--bg);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 10px;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 8px 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-range {
            width: 100%;
            -webkit-appearance: none;
            height: 2px;
            background: var(--bg);
            border-radius: 1px;
            margin-top: 8px;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 2px;
        }

        /* Trial Items */
        .trial-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .trial-item:hover {
            border-color: var(--accent);
        }

        .trial-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trial-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-lighter);
            color: var(--text-dim);
            font-size: 12px;
        }

        .trial-icon.running {
            background: var(--accent);
            color: var(--bg);
        }

        .trial-name {
            font-weight: 600;
            color: var(--text);
        }

        .trial-status {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .trial-status.running { color: var(--accent); }

        .trial-actions {
            display: flex;
            gap: 4px;
        }

        /* Table */
        .table-wrap {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        th {
            text-align: left;
            padding: 8px 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            top: 0;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover td {
            background: var(--bg);
        }

        .badge-method {
            padding: 2px 6px;
            font-size: 9px;
            border: 1px solid;
        }

        .badge-blue { border-color: var(--blue); color: var(--blue); }
        .badge-purple { border-color: var(--purple); color: var(--purple); }
        .badge-yellow { border-color: var(--yellow); color: var(--yellow); }

        .text-best {
            color: var(--accent);
            font-weight: 600;
        }

        /* Filters */
        .filters-inline {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            padding: 12px 16px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .filter-group {
            flex: 1;
        }

        .filter-group label {
            display: block;
            font-size: 9px;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .filter-group select {
            width: 100%;
            padding: 6px 8px;
            font-size: 11px;
        }

        /* Summary Boxes */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .summary-box {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }

        .summary-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
        }

        .image-card {
            aspect-ratio: 1;
            border: 1px solid var(--border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-card:hover {
            border-color: var(--accent);
        }

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 20, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .modal-overlay img {
            max-width: 100%;
            max-height: 100%;
            border: 1px solid var(--border);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10001;
        }

        .toast {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 16px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
        }

        .toast.error { border-color: var(--red); }
        .toast.success { border-color: var(--accent); }

        .toast i {
            color: var(--accent);
        }

        .toast.error i { color: var(--red); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .empty-state i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        /* VNC Status Grid */
        .vnc-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .vnc-status-item {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 10px;
            font-size: 11px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-dim);
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .grid-3 {
                grid-template-columns: 260px 1fr;
            }

            .grid-3 > *:nth-child(3) {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }

            .header {
                flex-direction: column;
                gap: 12px;
            }

            .header-nav {
                flex-wrap: wrap;
            }

            .filters-inline {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body x-data="dashboard()" x-init="init()">
    <!-- Terminal Header -->
    <header class="header">
        <div class="header-left">
            <div>
                <span class="prompt" x-text="(sessionStorage.getItem('username') || 'user') + '@control'">user@control</span>
                <span class="prompt-path">~/aquatic-mapping</span>
                <span style="color: var(--text);">$</span>
            </div>
            <nav class="header-nav">
                <button @click="currentTab = 'simulations'" :class="currentTab === 'simulations' ? 'active' : ''" class="tab-btn">
                    simulations
                </button>
                <button @click="currentTab = 'reconstruction'" :class="currentTab === 'reconstruction' ? 'active' : ''" class="tab-btn">
                    reconstruction
                </button>
                <button @click="currentTab = 'host'" :class="currentTab === 'host' ? 'active' : ''" class="tab-btn">
                    host
                </button>
            </nav>
        </div>

        <div class="header-right">
            <div class="status-indicator">
                <span class="dot" :class="connected ? 'pulse' : 'offline'"></span>
                <span x-text="connected ? 'online' : 'offline'"></span>
            </div>
            <button @click="logout()" class="btn btn-sm" style="margin-left: 10px;">
                <i class="fas fa-sign-out-alt"></i> logout
            </button>
        </div>
    </header>

    <main class="main">
        <!-- System Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">cpu</div>
                <div class="stat-value" x-text="system.cpu_percent + '%'">0%</div>
                <div class="stat-bar">
                    <div class="stat-fill" :style="'width: ' + system.cpu_percent + '%'"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">memory</div>
                <div class="stat-value" x-text="system.memory_used_gb + '/' + system.memory_total_gb + ' GB'">0/0 GB</div>
                <div class="stat-bar">
                    <div class="stat-fill" :style="'width: ' + system.memory_percent + '%'"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">gpu</div>
                <template x-if="system.gpu">
                    <div>
                        <div class="stat-value" x-text="system.gpu.utilization + '%'">0%</div>
                        <div class="stat-bar">
                            <div class="stat-fill" :style="'width: ' + system.gpu.utilization + '%'"></div>
                        </div>
                    </div>
                </template>
                <template x-if="!system.gpu"><div class="stat-value" style="color: var(--text-dim)">N/A</div></template>
            </div>
            <div class="stat-card">
                <div class="stat-label">gpu mem</div>
                <template x-if="system.gpu">
                    <div>
                        <div class="stat-value" x-text="Math.round(system.gpu.memory_used_mb/1024*10)/10 + '/' + Math.round(system.gpu.memory_total_mb/1024*10)/10 + ' GB'">0/0 GB</div>
                        <div class="stat-bar">
                            <div class="stat-fill" :style="'width: ' + (system.gpu.memory_used_mb / system.gpu.memory_total_mb * 100) + '%'"></div>
                        </div>
                    </div>
                </template>
                <template x-if="!system.gpu"><div class="stat-value" style="color: var(--text-dim)">N/A</div></template>
            </div>
        </div>

        <!-- Tab: Simulations -->
        <div x-show="currentTab === 'simulations'" x-cloak>
            <div class="grid-3">
                <!-- Controls -->
                <div>
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title"><i class="fas fa-rocket"></i> launch batch</span>
                        </div>
                        <div class="panel-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">start</label>
                                    <input type="number" x-model="batchStart" min="1" class="form-input">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">end</label>
                                    <input type="number" x-model="batchEnd" min="1" class="form-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">concurrent: <strong style="color: var(--accent)" x-text="concurrent"></strong></label>
                                <input type="range" x-model="concurrent" min="1" max="5" class="form-range">
                            </div>
                            <button @click="startBatch()" :disabled="loading" class="btn btn-primary btn-block">
                                <i class="fas fa-play"></i>
                                <span x-text="loading ? 'starting...' : 'launch'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 12px;">
                        <div class="panel-header">
                            <span class="panel-title"><i class="fas fa-tools"></i> actions</span>
                        </div>
                        <div class="panel-body" style="display: flex; flex-direction: column; gap: 8px;">
                            <button @click="startSingleTrial()" class="btn btn-block">
                                <i class="fas fa-plus"></i> single trial
                            </button>
                            <button @click="stopAll()" class="btn btn-danger btn-block">
                                <i class="fas fa-stop"></i> stop all
                            </button>
                            <button @click="refreshStatus()" class="btn btn-block">
                                <i class="fas fa-sync-alt"></i> refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Trials -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-server"></i> active trials</span>
                        <span class="badge" x-text="containers.filter(c => c.status === 'running').length + ' running'"></span>
                    </div>
                    <div class="panel-body" style="max-height: 450px; overflow-y: auto;">
                        <template x-if="containers.length > 0">
                            <div>
                                <template x-for="container in containers" :key="container.name">
                                    <div class="trial-item">
                                        <div class="trial-info">
                                            <div class="trial-icon" :class="container.status === 'running' ? 'running' : ''">
                                                <i class="fas fa-cube"></i>
                                            </div>
                                            <div>
                                                <div class="trial-name" x-text="'trial_' + container.trial_id"></div>
                                                <div class="trial-status" :class="container.status" x-text="container.status"></div>
                                            </div>
                                        </div>
                                        <div class="trial-actions">
                                            <template x-if="container.status === 'running' && container.vnc_port">
                                                <a :href="getTrialVncUrl(container.trial_id, container.vnc_port)" target="_blank" class="btn btn-sm">vnc</a>
                                            </template>
                                            <template x-if="container.status === 'running'">
                                                <button @click="stopTrial(container.trial_id)" class="btn btn-sm btn-danger"><i class="fas fa-stop"></i></button>
                                            </template>
                                            <template x-if="container.status !== 'running'">
                                                <button @click="removeTrial(container.trial_id)" class="btn btn-sm"><i class="fas fa-trash"></i></button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="containers.length === 0">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>no active containers</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Completed Trials -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-check-circle"></i> completed</span>
                    </div>
                    <div class="panel-body" style="max-height: 450px; overflow-y: auto;">
                        <template x-if="completedTrials.length > 0">
                            <div>
                                <template x-for="trial in completedTrials" :key="trial.id">
                                    <div class="trial-item">
                                        <div class="trial-info">
                                            <div class="trial-icon running">
                                                <i class="fas fa-check"></i>
                                            </div>
                                            <div>
                                                <div class="trial-name" x-text="'trial_' + trial.id"></div>
                                                <div class="trial-status" x-text="trial.field_count + ' fields'"></div>
                                            </div>
                                        </div>
                                        <div class="trial-actions">
                                            <a :href="'/api/download/' + trial.id" class="btn btn-sm"><i class="fas fa-download"></i></a>
                                            <button @click="runReconstruction(trial.id)" class="btn btn-sm btn-primary">recon</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="completedTrials.length === 0">
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>no completed trials</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Reconstruction -->
        <div x-show="currentTab === 'reconstruction'" x-cloak x-init="$watch('currentTab', val => val === 'reconstruction' && loadExistingResults())">
            <div class="grid-3">
                <!-- Controls -->
                <div>
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title"><i class="fas fa-play-circle"></i> run</span>
                        </div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label class="form-label">select trial</label>
                                <select x-model="reconTrial" @change="loadExistingResults()" class="form-select">
                                    <template x-for="trial in completedTrials" :key="trial.id">
                                        <option :value="trial.id" x-text="'trial_' + trial.id"></option>
                                    </template>
                                </select>
                            </div>
                            <button @click="startReconstruction()" :disabled="reconRunning" class="btn btn-primary btn-block">
                                <i class="fas fa-play" x-show="!reconRunning"></i>
                                <i class="fas fa-spinner fa-spin" x-show="reconRunning"></i>
                                <span x-text="reconRunning ? 'running...' : 'start'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 12px;">
                        <div class="panel-header">
                            <span class="panel-title"><i class="fas fa-th"></i> heatmap</span>
                        </div>
                        <div class="panel-body" style="display: flex; flex-direction: column; gap: 8px;">
                            <button @click="generateComparisonHeatmap()" :disabled="reconResults.length === 0" class="btn btn-block">
                                <i class="fas fa-magic"></i> generate
                            </button>
                            <button @click="showComparisonHeatmap()" :disabled="!hasComparisonHeatmap" class="btn btn-primary btn-block">
                                <i class="fas fa-eye"></i> view
                            </button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 12px;">
                        <div class="panel-body">
                            <button @click="deleteTrialData()" class="btn btn-danger btn-block">
                                <i class="fas fa-trash"></i> delete trial data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="panel" style="grid-column: span 2;">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-table"></i> results</span>
                        <span class="badge" x-text="filteredResults.length + '/' + reconResults.length"></span>
                    </div>

                    <!-- Inline Filters -->
                    <div class="filters-inline">
                        <div class="filter-group">
                            <label>field</label>
                            <select x-model="filterField">
                                <option value="all">all</option>
                                <option value="radial">radial</option>
                                <option value="x_compress">x_compress</option>
                                <option value="y_compress">y_compress</option>
                                <option value="x_compress_tilt">x_compress_tilt</option>
                                <option value="y_compress_tilt">y_compress_tilt</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>method</label>
                            <select x-model="filterMethod">
                                <option value="all">all</option>
                                <option value="standard_gp">standard_gp</option>
                                <option value="mchutchon_nigp">mchutchon_nigp</option>
                                <option value="girard">girard</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>kernel</label>
                            <select x-model="filterKernel">
                                <option value="all">all</option>
                                <option value="rbf">rbf</option>
                                <option value="matern15">matern15</option>
                                <option value="matern25">matern25</option>
                                <option value="exponential">exponential</option>
                            </select>
                        </div>
                    </div>

                    <div class="panel-body">
                        <template x-if="filteredResults.length > 0">
                            <div>
                                <div class="summary-row">
                                    <div class="summary-box">
                                        <div class="summary-label">best rmse</div>
                                        <div class="summary-value" x-text="Math.min(...filteredResults.map(r => r.rmse)).toFixed(4)"></div>
                                    </div>
                                    <div class="summary-box">
                                        <div class="summary-label">best nrmse</div>
                                        <div class="summary-value" x-text="Math.min(...filteredResults.map(r => r.nrmse)).toFixed(4)"></div>
                                    </div>
                                    <div class="summary-box">
                                        <div class="summary-label">methods</div>
                                        <div class="summary-value" x-text="[...new Set(filteredResults.map(r => r.method))].length"></div>
                                    </div>
                                </div>

                                <div class="table-wrap">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>field</th>
                                                <th>method</th>
                                                <th>kernel</th>
                                                <th>rmse</th>
                                                <th>nrmse</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="result in filteredResults" :key="result.field + result.method + result.kernel">
                                                <tr>
                                                    <td x-text="result.field"></td>
                                                    <td>
                                                        <span class="badge-method"
                                                            :class="{
                                                                'badge-blue': result.method === 'standard_gp',
                                                                'badge-purple': result.method === 'mchutchon_nigp',
                                                                'badge-yellow': result.method === 'girard'
                                                            }"
                                                            x-text="result.method"></span>
                                                    </td>
                                                    <td x-text="result.kernel"></td>
                                                    <td :class="result.rmse === Math.min(...filteredResults.filter(r => r.field === result.field).map(r => r.rmse)) ? 'text-best' : ''"
                                                        x-text="result.rmse.toFixed(4)"></td>
                                                    <td :class="result.nrmse === Math.min(...filteredResults.filter(r => r.field === result.field).map(r => r.nrmse)) ? 'text-best' : ''"
                                                        x-text="result.nrmse.toFixed(4)"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>

                        <template x-if="reconResults.length === 0 && !reconRunning">
                            <div class="empty-state">
                                <i class="fas fa-chart-area"></i>
                                <p>run reconstruction to see results</p>
                            </div>
                        </template>

                        <template x-if="reconRunning">
                            <div class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>running gp reconstruction...</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="panel" style="margin-top: 16px;" x-show="filteredImages.length > 0">
                <div class="panel-header">
                    <span class="panel-title"><i class="fas fa-images"></i> images</span>
                    <span class="badge" x-text="filteredImages.length + ' images'"></span>
                </div>
                <div class="image-grid">
                    <template x-for="img in filteredImages" :key="img.path">
                        <div class="image-card" @click="openImageModal(img.url)">
                            <img :src="img.url" :alt="img.name">
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Tab: Host PC -->
        <div x-show="currentTab === 'host'" x-cloak x-init="$watch('currentTab', val => val === 'host' && checkHostVncStatus())">
            <div class="grid-2">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-desktop"></i> remote desktop</span>
                    </div>
                    <div class="panel-body">
                        <div class="vnc-status-grid">
                            <div class="vnc-status-item">
                                <span class="dot" :style="hostVncStatus.x11vnc ? 'background: var(--accent)' : 'background: var(--text-dim)'"></span>
                                <span> x11vnc</span>
                                <div style="font-size: 10px; color: var(--text-dim); margin-top: 4px;" x-text="hostVncStatus.x11vnc ? 'port 5900' : 'stopped'"></div>
                            </div>
                            <div class="vnc-status-item">
                                <span class="dot" :style="hostVncStatus.novnc ? 'background: var(--accent)' : 'background: var(--text-dim)'"></span>
                                <span> novnc</span>
                                <div style="font-size: 10px; color: var(--text-dim); margin-top: 4px;" x-text="hostVncStatus.novnc ? 'port 6080' : 'stopped'"></div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <template x-if="!hostVncRunning">
                                <button @click="startHostVNC()" class="btn btn-primary" style="flex: 1;">
                                    <i class="fas fa-play"></i> start
                                </button>
                            </template>
                            <template x-if="hostVncRunning">
                                <button @click="stopHostVNC()" class="btn btn-danger" style="flex: 1;">
                                    <i class="fas fa-stop"></i> stop
                                </button>
                            </template>
                            <button @click="checkHostVncStatus()" class="btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>

                        <template x-if="hostVncRunning">
                            <a :href="getHostVncUrl()" target="_blank" class="btn btn-primary btn-block">
                                <i class="fas fa-external-link-alt"></i> open desktop
                            </a>
                        </template>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-server"></i> system info</span>
                    </div>
                    <div class="panel-body">
                        <div class="info-row">
                            <span class="info-label">status</span>
                            <span style="color: var(--accent);"><span class="dot pulse" style="display: inline-block; margin-right: 6px;"></span>online</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">gpu</span>
                            <span x-text="system.gpu ? system.gpu.name : 'N/A'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">gpu memory</span>
                            <span x-text="system.gpu ? Math.round(system.gpu.memory_total_mb/1024) + ' GB' : 'N/A'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">system ram</span>
                            <span x-text="system.memory_total_gb + ' GB'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">cpu usage</span>
                            <span style="color: var(--accent);" x-text="system.cpu_percent + '%'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div x-show="imageModalOpen" x-cloak class="modal-overlay" @click="imageModalOpen = false">
        <img :src="imageModalUrl">
        <button class="modal-close" @click="imageModalOpen = false"><i class="fas fa-times"></i></button>
    </div>

    <!-- Toasts -->
    <div class="toast-container" x-show="notifications.length > 0">
        <template x-for="(notif, index) in notifications" :key="index">
            <div class="toast" :class="notif.type">
                <i :class="notif.type === 'success' ? 'fas fa-check-circle' : notif.type === 'error' ? 'fas fa-times-circle' : 'fas fa-info-circle'"></i>
                <span x-text="notif.message"></span>
            </div>
        </template>
    </div>

    <script>
        function dashboard() {
            return {
                connected: false,
                loading: false,
                currentTab: 'simulations',
                batchStart: 1,
                batchEnd: 10,
                concurrent: 3,
                containers: [],
                completedTrials: [],
                system: { cpu_percent: 0, memory_percent: 0, memory_used_gb: 0, memory_total_gb: 0, gpu: null },
                notifications: [],
                ws: null,
                reconTrial: '1',
                reconRunning: false,
                reconResults: [],
                reconImages: [],
                reconError: null,
                filterField: 'all',
                filterMethod: 'all',
                filterKernel: 'all',
                imageModalOpen: false,
                imageModalUrl: '',
                hostVncRunning: false,
                hostVncStatus: { x11vnc: false, novnc: false },

                // Auth helper - get authorization header
                getAuthHeader() {
                    const auth = sessionStorage.getItem('auth');
                    return auth ? { 'Authorization': 'Basic ' + auth } : {};
                },

                // Authenticated fetch wrapper
                async authFetch(url, options = {}) {
                    const headers = { ...options.headers, ...this.getAuthHeader() };
                    const response = await fetch(url, { ...options, headers });
                    if (response.status === 401) {
                        // Not authenticated, redirect to login
                        sessionStorage.removeItem('auth');
                        sessionStorage.removeItem('username');
                        window.location.href = '/login';
                        throw new Error('Unauthorized');
                    }
                    return response;
                },

                get filteredResults() {
                    return this.reconResults.filter(r => {
                        if (this.filterField !== 'all' && r.field !== this.filterField) return false;
                        if (this.filterMethod !== 'all' && r.method !== this.filterMethod) return false;
                        if (this.filterKernel !== 'all' && r.kernel !== this.filterKernel) return false;
                        return true;
                    });
                },

                get hasComparisonHeatmap() {
                    return this.reconImages.some(i => i.name.includes('comparison') || i.name.includes('heatmap') || i.path.includes('comparison'));
                },

                get filteredImages() {
                    return this.reconImages.filter(img => {
                        if (img.name.includes('comparison') || img.name.includes('heatmap') || img.path.includes('comparison')) return false;
                        const parts = img.path.split('/');
                        if (parts.length < 4) return false;
                        const method = parts[0], field = parts[1], kernel = parts[2];
                        if (this.filterField !== 'all' && field !== this.filterField) return false;
                        if (this.filterMethod !== 'all' && method !== this.filterMethod) return false;
                        if (this.filterKernel !== 'all' && kernel !== this.filterKernel) return false;
                        return true;
                    });
                },

                init() {
                    // Check if authenticated
                    if (!sessionStorage.getItem('auth')) {
                        window.location.href = '/login';
                        return;
                    }
                    this.connectWebSocket();
                    this.refreshStatus();
                    this.loadCompletedTrials().then(() => {
                        if (this.reconTrial) this.loadExistingResults();
                    });
                    this.checkHostVncStatus();
                },

                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
                    this.ws.onopen = () => { this.connected = true; };
                    this.ws.onclose = () => { this.connected = false; setTimeout(() => this.connectWebSocket(), 3000); };
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.containers) this.containers = data.containers;
                        if (data.system) this.system = data.system;
                    };
                },

                async refreshStatus() {
                    try {
                        const response = await this.authFetch('/api/status');
                        const data = await response.json();
                        this.containers = data.containers;
                        this.system = data.system;
                        this.connected = true;
                    } catch (e) {
                        console.error(e);
                        this.connected = false;
                    }
                },

                async loadCompletedTrials() {
                    try {
                        const response = await this.authFetch('/api/trials/completed');
                        this.completedTrials = await response.json();
                        if (this.completedTrials.length > 0) this.reconTrial = this.completedTrials[0].id;
                        return this.completedTrials;
                    } catch (e) { return []; }
                },

                async startBatch() {
                    this.loading = true;
                    try {
                        const response = await this.authFetch('/api/batch/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ start_trial: parseInt(this.batchStart), end_trial: parseInt(this.batchEnd), concurrent: parseInt(this.concurrent) })
                        });
                        const data = await response.json();
                        this.notify('success', `started ${data.started.length} trials`);
                        this.refreshStatus();
                    } catch (e) { this.notify('error', 'failed to start batch'); }
                    this.loading = false;
                },

                async startSingleTrial() {
                    const trialId = prompt('enter trial number:');
                    if (trialId) {
                        try {
                            await this.authFetch(`/api/trial/start/${trialId}`, { method: 'POST' });
                            this.notify('success', `trial ${trialId} started`);
                            this.refreshStatus();
                        } catch (e) { this.notify('error', 'failed to start trial'); }
                    }
                },

                async stopTrial(trialId) {
                    try {
                        await this.authFetch(`/api/trial/stop/${trialId}`, { method: 'POST' });
                        this.notify('success', `trial ${trialId} stopped`);
                        this.refreshStatus();
                    } catch (e) { this.notify('error', 'failed to stop trial'); }
                },

                async removeTrial(trialId) {
                    try {
                        await this.authFetch(`/api/trial/${trialId}`, { method: 'DELETE' });
                        this.notify('success', `trial ${trialId} removed`);
                        this.refreshStatus();
                    } catch (e) { this.notify('error', 'failed to remove trial'); }
                },

                getTrialVncUrl(trialId, vncPort) {
                    const hostname = window.location.hostname;
                    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.')) {
                        return `http://${hostname}:${vncPort}/vnc.html`;
                    }
                    return `https://trial${trialId}.${hostname}/vnc.html`;
                },

                getHostVncUrl() {
                    const hostname = window.location.hostname;
                    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.')) {
                        return `http://${hostname}:6080/vnc.html`;
                    }
                    return `https://vnc.${hostname}/vnc.html`;
                },

                async stopAll() {
                    if (confirm('stop all running trials?')) {
                        try {
                            await this.authFetch('/api/batch/stop', { method: 'POST' });
                            this.notify('success', 'all trials stopped');
                            this.refreshStatus();
                        } catch (e) { this.notify('error', 'failed to stop trials'); }
                    }
                },

                runReconstruction(trialId) {
                    this.reconTrial = trialId;
                    this.currentTab = 'reconstruction';
                },

                async startReconstruction() {
                    this.reconRunning = true;
                    this.reconResults = [];
                    this.reconError = null;
                    try {
                        const response = await this.authFetch(`/api/reconstruct/${this.reconTrial}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ field: 'all', method: 'all' })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.notify('info', `reconstruction started for trial ${this.reconTrial}`);
                            this.pollReconstructionStatus();
                        } else {
                            this.notify('error', data.message || 'failed');
                            this.reconRunning = false;
                        }
                    } catch (e) {
                        this.notify('error', 'reconstruction failed');
                        this.reconRunning = false;
                    }
                },

                async pollReconstructionStatus() {
                    const poll = async () => {
                        try {
                            const response = await this.authFetch(`/api/reconstruct/${this.reconTrial}/status`);
                            const data = await response.json();
                            if (data.running) {
                                setTimeout(poll, 2000);
                            } else {
                                if (data.success === false || data.return_code !== 0) {
                                    this.reconError = data.error || 'failed';
                                    this.notify('error', 'reconstruction failed');
                                    this.reconRunning = false;
                                } else {
                                    this.reconError = null;
                                    setTimeout(() => this.loadReconstructionResults(), 1000);
                                }
                            }
                        } catch (e) {
                            this.reconRunning = false;
                            this.reconError = 'status check failed';
                        }
                    };
                    poll();
                },

                async loadReconstructionResults() {
                    try {
                        const response = await this.authFetch(`/api/reconstruct/${this.reconTrial}/results`);
                        if (response.ok) {
                            const data = await response.json();
                            this.reconResults = data.results || [];
                        } else {
                            this.reconResults = [];
                        }
                        await this.loadReconstructionImages();
                        if (this.reconResults.length > 0) {
                            this.notify('success', `loaded ${this.reconResults.length} results`);
                        }
                    } catch (e) {
                        this.notify('error', 'failed to load results');
                        this.reconResults = [];
                        this.reconImages = [];
                    }
                    this.reconRunning = false;
                },

                async loadReconstructionImages() {
                    try {
                        const response = await this.authFetch(`/api/reconstruct/${this.reconTrial}/images`);
                        if (response.ok) {
                            const data = await response.json();
                            this.reconImages = data.images || [];
                        } else {
                            this.reconImages = [];
                        }
                    } catch (e) {
                        this.reconImages = [];
                    }
                },

                async loadExistingResults() {
                    if (!this.reconTrial) return;
                    this.reconError = null;
                    try {
                        const response = await this.authFetch(`/api/reconstruct/${this.reconTrial}/results`);
                        if (response.ok) {
                            const data = await response.json();
                            this.reconResults = data.results || [];
                        } else {
                            this.reconResults = [];
                        }
                        await this.loadReconstructionImages();
                    } catch (e) {
                        this.reconResults = [];
                        this.reconImages = [];
                    }
                },

                async generateComparisonHeatmap() {
                    if (this.reconResults.length === 0) return;
                    this.reconRunning = true;
                    try {
                        const response = await this.authFetch(`/api/reconstruct/${this.reconTrial}/generate-heatmap`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            this.notify('success', 'heatmap generated');
                            await this.loadReconstructionImages();
                        } else {
                            this.notify('error', 'failed to generate heatmap');
                        }
                    } catch (e) {
                        this.notify('error', 'failed to generate heatmap');
                    }
                    this.reconRunning = false;
                },

                showComparisonHeatmap() {
                    const heatmap = this.reconImages.find(i => i.name.includes('comparison') || i.name.includes('heatmap'));
                    if (heatmap) this.openImageModal(heatmap.url);
                },

                openImageModal(url) {
                    this.imageModalUrl = url;
                    this.imageModalOpen = true;
                },

                async deleteTrialData() {
                    if (!confirm(`delete all data for trial ${this.reconTrial}?`)) return;
                    try {
                        const response = await this.authFetch(`/api/trial/${this.reconTrial}/data`, { method: 'DELETE' });
                        const data = await response.json();
                        if (data.success) {
                            this.notify('success', 'trial deleted');
                            this.reconResults = [];
                            this.reconImages = [];
                            this.reconError = null;
                            await this.loadCompletedTrials();
                            if (this.completedTrials.length > 0) {
                                this.reconTrial = this.completedTrials[0].id;
                                await this.loadExistingResults();
                            }
                        } else {
                            this.notify('error', 'delete failed');
                        }
                    } catch (e) {
                        this.notify('error', 'failed to delete');
                    }
                },

                async startHostVNC() {
                    try {
                        const response = await this.authFetch('/api/host/vnc/start', { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            this.hostVncRunning = true;
                            this.notify('success', 'vnc started');
                        } else {
                            this.notify('error', 'failed to start vnc');
                        }
                    } catch (e) { this.notify('error', 'failed to start vnc'); }
                },

                async stopHostVNC() {
                    try {
                        await this.authFetch('/api/host/vnc/stop', { method: 'POST' });
                        this.hostVncRunning = false;
                        this.notify('success', 'vnc stopped');
                    } catch (e) { this.notify('error', 'failed to stop vnc'); }
                },

                async checkHostVncStatus() {
                    try {
                        const response = await this.authFetch('/api/host/vnc/status');
                        const data = await response.json();
                        this.hostVncRunning = data.running;
                        this.hostVncStatus = { x11vnc: data.x11vnc_running || false, novnc: data.novnc_running || false };
                    } catch (e) {
                        this.hostVncRunning = false;
                        this.hostVncStatus = { x11vnc: false, novnc: false };
                    }
                },

                notify(type, message) {
                    this.notifications.push({ type, message });
                    setTimeout(() => this.notifications.shift(), 3000);
                },

                logout() {
                    sessionStorage.removeItem('auth');
                    sessionStorage.removeItem('username');
                    window.location.href = '/login';
                }
            }
        }
    </script>
</body>
</html>
