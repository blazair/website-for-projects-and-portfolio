<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chronicle - Control Room</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;900&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper: #f4ead5;
            --paper-cream: #faf6eb;
            --paper-aged: #e8dcc4;
            --paper-dark: #d9ccb4;
            --ink: #1a1a1a;
            --ink-light: #3d3d3d;
            --ink-faded: #6a6a6a;
            --olive: #4a5d23;
            --olive-dark: #3a4a1c;
            --olive-light: #5a6d33;
            --orange: #c4640c;
            --rust: #8b4513;
            --aqua: #2a6a6a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        [x-cloak] { display: none !important; }

        body {
            font-family: 'EB Garamond', Georgia, serif;
            background: var(--paper);
            color: var(--ink);
            font-size: 16px;
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Paper texture */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 9999;
        }

        /* ========================================
           HEADER
           ======================================== */
        .header {
            background: var(--ink);
            color: var(--paper);
            padding: 15px 0;
            border-bottom: 3px solid var(--olive);
        }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-link {
            color: var(--paper-aged);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--paper);
        }

        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .header-title span {
            color: var(--olive-light);
            font-style: italic;
            font-weight: 400;
        }

        .header-nav {
            display: flex;
            gap: 5px;
        }

        .tab-btn {
            padding: 8px 16px;
            font-family: 'EB Garamond', serif;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--paper-aged);
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--paper);
        }

        .tab-btn.active {
            background: var(--olive);
            color: var(--paper);
            border-color: var(--olive);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
        }

        .status-dot {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--olive-light);
        }

        .dot.offline { background: var(--rust); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dot.pulse { animation: pulse 2s infinite; }

        /* ========================================
           MAIN LAYOUT
           ======================================== */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px 30px;
        }

        /* ========================================
           SYSTEM STATS BAR
           ======================================== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--paper-cream);
            border: 2px solid var(--ink);
            padding: 15px 18px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-faded);
        }

        .stat-icon {
            font-size: 14px;
            color: var(--olive);
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--ink);
            margin-bottom: 8px;
        }

        .stat-bar {
            height: 4px;
            background: var(--paper-dark);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: var(--olive);
            transition: width 0.5s ease;
        }

        /* ========================================
           CARDS
           ======================================== */
        .card {
            background: var(--paper-cream);
            border: 2px solid var(--ink);
        }

        .card-header {
            padding: 12px 18px;
            border-bottom: 2px solid var(--ink);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--paper);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--olive);
        }

        .card-badge {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--ink);
            color: var(--paper);
        }

        .card-body {
            padding: 18px;
        }

        /* ========================================
           FORMS & INPUTS
           ======================================== */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-faded);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-family: 'EB Garamond', serif;
            font-size: 15px;
            background: var(--paper);
            border: 1px solid var(--ink-faded);
            color: var(--ink);
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--olive);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            font-family: 'EB Garamond', serif;
            font-size: 15px;
            background: var(--paper);
            border: 1px solid var(--ink-faded);
            color: var(--ink);
            cursor: pointer;
        }

        .form-range {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            background: var(--paper-dark);
            border-radius: 2px;
            margin-top: 8px;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--olive);
            border-radius: 50%;
            cursor: pointer;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            font-family: 'EB Garamond', serif;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--ink);
            background: var(--paper);
            color: var(--ink);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--ink);
            color: var(--paper);
        }

        .btn-primary {
            background: var(--olive);
            border-color: var(--olive);
            color: var(--paper);
        }

        .btn-primary:hover {
            background: var(--olive-dark);
            border-color: var(--olive-dark);
        }

        .btn-danger {
            background: var(--paper);
            border-color: var(--rust);
            color: var(--rust);
        }

        .btn-danger:hover {
            background: var(--rust);
            color: var(--paper);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
        }

        .btn-block {
            width: 100%;
        }

        /* ========================================
           GRID LAYOUTS
           ======================================== */
        .grid-3 {
            display: grid;
            grid-template-columns: 280px 1fr 1fr;
            gap: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .space-y > * + * {
            margin-top: 15px;
        }

        /* ========================================
           TRIAL ITEMS
           ======================================== */
        .trial-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--paper);
            border: 1px solid var(--ink-faded);
            margin-bottom: 10px;
        }

        .trial-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .trial-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--paper-aged);
            border: 1px solid var(--ink-faded);
        }

        .trial-icon.running {
            background: var(--olive);
            border-color: var(--olive);
            color: var(--paper);
        }

        .trial-name {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
        }

        .trial-status {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .trial-status.running { color: var(--olive); }
        .trial-status.exited { color: var(--ink-faded); }

        .trial-actions {
            display: flex;
            gap: 6px;
        }

        .trial-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--ink-faded);
        }

        .trial-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-faded);
            margin-bottom: 4px;
        }

        /* ========================================
           FILTERS - INLINE COMPACT
           ======================================== */
        .filters-inline {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 15px 18px;
            background: var(--paper);
            border-bottom: 1px solid var(--ink-faded);
        }

        .filter-group {
            flex: 1;
        }

        .filter-group label {
            display: block;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-faded);
            margin-bottom: 4px;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 10px;
            font-family: 'EB Garamond', serif;
            font-size: 13px;
            background: var(--paper-cream);
            border: 1px solid var(--ink-faded);
            color: var(--ink);
        }

        /* ========================================
           TABLE
           ======================================== */
        .table-wrap {
            overflow-x: auto;
            max-height: 350px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-faded);
            border-bottom: 2px solid var(--ink);
            background: var(--paper);
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--paper-dark);
        }

        tr:hover td {
            background: var(--paper);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-blue { background: var(--aqua); color: var(--paper); }
        .badge-orange { background: var(--orange); color: var(--paper); }
        .badge-olive { background: var(--olive); color: var(--paper); }

        .text-mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .text-best {
            color: var(--olive);
            font-weight: 600;
        }

        /* ========================================
           IMAGE GRID
           ======================================== */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .image-card {
            aspect-ratio: 1;
            border: 1px solid var(--ink-faded);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-card:hover {
            border-color: var(--olive);
            transform: scale(1.02);
        }

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========================================
           SUMMARY BOXES
           ======================================== */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .summary-box {
            background: var(--paper);
            border: 1px solid var(--ink-faded);
            padding: 12px;
            text-align: center;
        }

        .summary-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-faded);
            margin-bottom: 5px;
        }

        .summary-value {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--olive);
        }

        /* ========================================
           EMPTY STATE
           ======================================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--ink-faded);
        }

        .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        /* ========================================
           MODAL
           ======================================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(26, 26, 26, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .modal-overlay img {
            max-width: 100%;
            max-height: 100%;
            border: 3px solid var(--paper);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--paper);
            font-size: 24px;
            cursor: pointer;
        }

        /* ========================================
           TOAST
           ======================================== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10001;
        }

        .toast {
            background: var(--ink);
            color: var(--paper);
            padding: 12px 18px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            border-left: 3px solid var(--olive);
        }

        .toast.error { border-left-color: var(--rust); }
        .toast.success { border-left-color: var(--olive); }

        /* ========================================
           HOST PC TAB
           ======================================== */
        .vnc-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .vnc-status-item {
            background: var(--paper);
            border: 1px solid var(--ink-faded);
            padding: 12px;
        }

        .vnc-status-item .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--ink-faded);
            font-size: 14px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--ink-faded);
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 1100px) {
            .grid-3 {
                grid-template-columns: 260px 1fr;
            }

            .grid-3 > *:nth-child(3) {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }

            .header-inner {
                flex-direction: column;
                gap: 15px;
            }

            .header-nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .filters-inline {
                flex-wrap: wrap;
            }

            .filter-group {
                flex: 1 1 45%;
            }
        }
    </style>
</head>
<body x-data="dashboard()" x-init="init()">
    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <div class="header-left">
                <a href="/" class="back-link">
                    <i class="fas fa-arrow-left"></i> Chronicle
                </a>
                <h1 class="header-title">Control Room <span>Field Reconstruction</span></h1>
            </div>

            <nav class="header-nav">
                <button @click="currentTab = 'simulations'" :class="currentTab === 'simulations' ? 'active' : ''" class="tab-btn">
                    <i class="fas fa-flask"></i> Simulations
                </button>
                <button @click="currentTab = 'reconstruction'" :class="currentTab === 'reconstruction' ? 'active' : ''" class="tab-btn">
                    <i class="fas fa-chart-area"></i> Reconstruction
                </button>
                <button @click="currentTab = 'host'" :class="currentTab === 'host' ? 'active' : ''" class="tab-btn">
                    <i class="fas fa-desktop"></i> Host PC
                </button>
            </nav>

            <div class="header-status">
                <div class="status-dot">
                    <span class="dot" :class="connected ? 'pulse' : 'offline'"></span>
                    <span x-text="connected ? 'Live' : 'Offline'"></span>
                </div>
                <span style="color: var(--paper-aged)"><i class="fas fa-user"></i> {{ username }}</span>
                <button @click="logout()" class="btn btn-sm" style="padding: 6px 12px; margin-left: 15px; border-color: var(--paper-aged); color: var(--paper-aged);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- System Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">CPU</span>
                    <i class="fas fa-microchip stat-icon"></i>
                </div>
                <div class="stat-value" x-text="system.cpu_percent + '%'">0%</div>
                <div class="stat-bar">
                    <div class="stat-fill" :style="'width: ' + system.cpu_percent + '%'"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Memory</span>
                    <i class="fas fa-memory stat-icon"></i>
                </div>
                <div class="stat-value" x-text="system.memory_used_gb + '/' + system.memory_total_gb + ' GB'">0/0 GB</div>
                <div class="stat-bar">
                    <div class="stat-fill" :style="'width: ' + system.memory_percent + '%'"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">GPU</span>
                    <i class="fas fa-bolt stat-icon"></i>
                </div>
                <template x-if="system.gpu">
                    <div>
                        <div class="stat-value" x-text="system.gpu.utilization + '%'">0%</div>
                        <div class="stat-bar">
                            <div class="stat-fill" :style="'width: ' + system.gpu.utilization + '%'"></div>
                        </div>
                    </div>
                </template>
                <template x-if="!system.gpu"><div class="stat-value" style="color: var(--ink-faded)">N/A</div></template>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">GPU Mem</span>
                    <i class="fas fa-database stat-icon"></i>
                </div>
                <template x-if="system.gpu">
                    <div>
                        <div class="stat-value" x-text="Math.round(system.gpu.memory_used_mb/1024*10)/10 + '/' + Math.round(system.gpu.memory_total_mb/1024*10)/10 + ' GB'">0/0 GB</div>
                        <div class="stat-bar">
                            <div class="stat-fill" :style="'width: ' + (system.gpu.memory_used_mb / system.gpu.memory_total_mb * 100) + '%'"></div>
                        </div>
                    </div>
                </template>
                <template x-if="!system.gpu"><div class="stat-value" style="color: var(--ink-faded)">N/A</div></template>
            </div>
        </div>

        <!-- Tab: Simulations -->
        <div x-show="currentTab === 'simulations'" x-cloak>
            <div class="grid-3">
                <!-- Controls -->
                <div class="space-y">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-rocket"></i> Launch Batch</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">Start</label>
                                    <input type="number" x-model="batchStart" min="1" class="form-input">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">End</label>
                                    <input type="number" x-model="batchEnd" min="1" class="form-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Concurrent: <strong x-text="concurrent"></strong></label>
                                <input type="range" x-model="concurrent" min="1" max="5" class="form-range">
                            </div>
                            <button @click="startBatch()" :disabled="loading" class="btn btn-primary btn-block">
                                <i class="fas fa-play"></i>
                                <span x-text="loading ? 'Starting...' : 'Launch'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-tools"></i> Actions</span>
                        </div>
                        <div class="card-body space-y">
                            <button @click="startSingleTrial()" class="btn btn-block">
                                <i class="fas fa-plus"></i> Single Trial
                            </button>
                            <button @click="stopAll()" class="btn btn-danger btn-block">
                                <i class="fas fa-stop"></i> Stop All
                            </button>
                            <button @click="refreshStatus()" class="btn btn-block">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Trials -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-server"></i> Active Trials</span>
                        <span class="card-badge" x-text="containers.filter(c => c.status === 'running').length + ' running'"></span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <template x-if="containers.length > 0">
                            <div>
                                <template x-for="container in containers" :key="container.name">
                                    <div class="trial-item">
                                        <div class="trial-info">
                                            <div class="trial-icon" :class="container.status === 'running' ? 'running' : ''">
                                                <i class="fas fa-cube"></i>
                                            </div>
                                            <div>
                                                <div class="trial-name" x-text="'Trial ' + container.trial_id"></div>
                                                <div class="trial-status" :class="container.status" x-text="container.status"></div>
                                            </div>
                                        </div>
                                        <div class="trial-actions">
                                            <template x-if="container.status === 'running' && container.vnc_port">
                                                <a :href="getTrialVncUrl(container.trial_id, container.vnc_port)" target="_blank" class="btn btn-sm">VNC</a>
                                            </template>
                                            <template x-if="container.status === 'running'">
                                                <button @click="stopTrial(container.trial_id)" class="btn btn-sm btn-danger"><i class="fas fa-stop"></i></button>
                                            </template>
                                            <template x-if="container.status !== 'running'">
                                                <button @click="removeTrial(container.trial_id)" class="btn btn-sm"><i class="fas fa-trash"></i></button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="containers.length === 0">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>No active containers</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Completed Trials -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-check-circle"></i> Completed</span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <template x-if="completedTrials.length > 0">
                            <div>
                                <template x-for="trial in completedTrials" :key="trial.id">
                                    <div class="trial-item">
                                        <div class="trial-info">
                                            <div class="trial-icon" style="background: var(--olive); border-color: var(--olive); color: var(--paper);">
                                                <i class="fas fa-check"></i>
                                            </div>
                                            <div>
                                                <div class="trial-name" x-text="'Trial ' + trial.id"></div>
                                                <div class="trial-status" x-text="trial.field_count + ' fields'"></div>
                                            </div>
                                        </div>
                                        <div class="trial-actions">
                                            <a :href="'/api/download/' + trial.id" class="btn btn-sm"><i class="fas fa-download"></i></a>
                                            <button @click="runReconstruction(trial.id)" class="btn btn-sm btn-primary">Recon</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="completedTrials.length === 0">
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>No completed trials</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Reconstruction -->
        <div x-show="currentTab === 'reconstruction'" x-cloak x-init="$watch('currentTab', val => val === 'reconstruction' && loadExistingResults())">
            <div class="grid-3">
                <!-- Controls -->
                <div class="space-y">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-play-circle"></i> Run</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Trial</label>
                                <select x-model="reconTrial" @change="loadExistingResults()" class="form-select">
                                    <template x-for="trial in completedTrials" :key="trial.id">
                                        <option :value="trial.id" x-text="'Trial ' + trial.id"></option>
                                    </template>
                                </select>
                            </div>
                            <button @click="startReconstruction()" :disabled="reconRunning" class="btn btn-primary btn-block">
                                <i class="fas fa-play" x-show="!reconRunning"></i>
                                <i class="fas fa-spinner fa-spin" x-show="reconRunning"></i>
                                <span x-text="reconRunning ? 'Running...' : 'Start'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-th"></i> Heatmap</span>
                        </div>
                        <div class="card-body space-y">
                            <button @click="generateComparisonHeatmap()" :disabled="reconResults.length === 0" class="btn btn-block">
                                <i class="fas fa-magic"></i> Generate
                            </button>
                            <button @click="showComparisonHeatmap()" :disabled="!hasComparisonHeatmap" class="btn btn-primary btn-block">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <button @click="deleteTrialData()" class="btn btn-danger btn-block">
                                <i class="fas fa-trash"></i> Delete Trial Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-table"></i> Results</span>
                        <span class="card-badge" x-text="filteredResults.length + '/' + reconResults.length"></span>
                    </div>

                    <!-- Inline Filters -->
                    <div class="filters-inline">
                        <div class="filter-group">
                            <label>Field</label>
                            <select x-model="filterField">
                                <option value="all">All Fields</option>
                                <option value="radial">Radial</option>
                                <option value="x_compress">X Compress</option>
                                <option value="y_compress">Y Compress</option>
                                <option value="x_compress_tilt">X Compress Tilt</option>
                                <option value="y_compress_tilt">Y Compress Tilt</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Method</label>
                            <select x-model="filterMethod">
                                <option value="all">All Methods</option>
                                <option value="standard_gp">Standard GP</option>
                                <option value="mchutchon_nigp">McHutchon NIGP</option>
                                <option value="girard">Girard</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Kernel</label>
                            <select x-model="filterKernel">
                                <option value="all">All Kernels</option>
                                <option value="rbf">RBF</option>
                                <option value="matern15">Matern 1.5</option>
                                <option value="matern25">Matern 2.5</option>
                                <option value="exponential">Exponential</option>
                            </select>
                        </div>
                    </div>

                    <div class="card-body">
                        <template x-if="filteredResults.length > 0">
                            <div>
                                <div class="summary-row">
                                    <div class="summary-box">
                                        <div class="summary-label">Best RMSE</div>
                                        <div class="summary-value" x-text="Math.min(...filteredResults.map(r => r.rmse)).toFixed(4)"></div>
                                    </div>
                                    <div class="summary-box">
                                        <div class="summary-label">Best NRMSE</div>
                                        <div class="summary-value" x-text="Math.min(...filteredResults.map(r => r.nrmse)).toFixed(4)"></div>
                                    </div>
                                    <div class="summary-box">
                                        <div class="summary-label">Methods</div>
                                        <div class="summary-value" x-text="[...new Set(filteredResults.map(r => r.method))].length"></div>
                                    </div>
                                </div>

                                <div class="table-wrap">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Field</th>
                                                <th>Method</th>
                                                <th>Kernel</th>
                                                <th>RMSE</th>
                                                <th>NRMSE</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="result in filteredResults" :key="result.field + result.method + result.kernel">
                                                <tr>
                                                    <td x-text="result.field"></td>
                                                    <td>
                                                        <span class="badge"
                                                            :class="{
                                                                'badge-blue': result.method === 'standard_gp',
                                                                'badge-orange': result.method === 'mchutchon_nigp',
                                                                'badge-olive': result.method === 'girard'
                                                            }"
                                                            x-text="result.method.replace('_', ' ')"></span>
                                                    </td>
                                                    <td x-text="result.kernel"></td>
                                                    <td class="text-mono"
                                                        :class="result.rmse === Math.min(...filteredResults.filter(r => r.field === result.field).map(r => r.rmse)) ? 'text-best' : ''"
                                                        x-text="result.rmse.toFixed(4)"></td>
                                                    <td class="text-mono"
                                                        :class="result.nrmse === Math.min(...filteredResults.filter(r => r.field === result.field).map(r => r.nrmse)) ? 'text-best' : ''"
                                                        x-text="result.nrmse.toFixed(4)"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>

                        <template x-if="reconResults.length === 0 && !reconRunning">
                            <div class="empty-state">
                                <i class="fas fa-chart-area"></i>
                                <p>Run a reconstruction to see results</p>
                            </div>
                        </template>

                        <template x-if="reconRunning">
                            <div class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Running GP reconstruction...</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="card" style="margin-top: 20px;" x-show="filteredImages.length > 0">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-images"></i> Images</span>
                    <span class="card-badge" x-text="filteredImages.length + ' images'"></span>
                </div>
                <div class="image-grid">
                    <template x-for="img in filteredImages" :key="img.path">
                        <div class="image-card" @click="openImageModal(img.url)">
                            <img :src="img.url" :alt="img.name">
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Tab: Host PC -->
        <div x-show="currentTab === 'host'" x-cloak x-init="$watch('currentTab', val => val === 'host' && checkHostVncStatus())">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-desktop"></i> Remote Desktop</span>
                    </div>
                    <div class="card-body">
                        <div class="vnc-status-grid">
                            <div class="vnc-status-item">
                                <span class="dot" :style="hostVncStatus.x11vnc ? 'background: var(--olive)' : 'background: var(--ink-faded)'"></span>
                                <span>x11vnc</span>
                                <div style="font-size: 11px; color: var(--ink-faded); margin-top: 4px;" x-text="hostVncStatus.x11vnc ? 'Port 5900' : 'Stopped'"></div>
                            </div>
                            <div class="vnc-status-item">
                                <span class="dot" :style="hostVncStatus.novnc ? 'background: var(--olive)' : 'background: var(--ink-faded)'"></span>
                                <span>noVNC</span>
                                <div style="font-size: 11px; color: var(--ink-faded); margin-top: 4px;" x-text="hostVncStatus.novnc ? 'Port 6080' : 'Stopped'"></div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <template x-if="!hostVncRunning">
                                <button @click="startHostVNC()" class="btn btn-primary" style="flex: 1;">
                                    <i class="fas fa-play"></i> Start
                                </button>
                            </template>
                            <template x-if="hostVncRunning">
                                <button @click="stopHostVNC()" class="btn btn-danger" style="flex: 1;">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                            </template>
                            <button @click="checkHostVncStatus()" class="btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>

                        <template x-if="hostVncRunning">
                            <a :href="getHostVncUrl()" target="_blank" class="btn btn-primary btn-block">
                                <i class="fas fa-external-link-alt"></i> Open Desktop
                            </a>
                        </template>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-server"></i> System Info</span>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span style="color: var(--olive);"><span class="dot pulse" style="background: var(--olive); display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px;"></span>Online</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">GPU</span>
                            <span x-text="system.gpu ? system.gpu.name : 'N/A'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">GPU Memory</span>
                            <span x-text="system.gpu ? Math.round(system.gpu.memory_total_mb/1024) + ' GB' : 'N/A'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">System RAM</span>
                            <span x-text="system.memory_total_gb + ' GB'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CPU Usage</span>
                            <span style="color: var(--olive);" x-text="system.cpu_percent + '%'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div x-show="imageModalOpen" x-cloak class="modal-overlay" @click="imageModalOpen = false">
        <img :src="imageModalUrl">
        <button class="modal-close" @click="imageModalOpen = false"><i class="fas fa-times"></i></button>
    </div>

    <!-- Toasts -->
    <div class="toast-container" x-show="notifications.length > 0">
        <template x-for="(notif, index) in notifications" :key="index">
            <div class="toast" :class="notif.type">
                <i :class="notif.type === 'success' ? 'fas fa-check-circle' : notif.type === 'error' ? 'fas fa-times-circle' : 'fas fa-info-circle'"></i>
                <span x-text="notif.message"></span>
            </div>
        </template>
    </div>

    <script>
        function dashboard() {
            return {
                connected: false,
                loading: false,
                currentTab: 'simulations',
                batchStart: 1,
                batchEnd: 10,
                concurrent: 3,
                containers: [],
                completedTrials: [],
                system: { cpu_percent: 0, memory_percent: 0, memory_used_gb: 0, memory_total_gb: 0, gpu: null },
                notifications: [],
                ws: null,
                reconTrial: '1',
                reconRunning: false,
                reconResults: [],
                reconImages: [],
                reconError: null,
                filterField: 'all',
                filterMethod: 'all',
                filterKernel: 'all',
                imageModalOpen: false,
                imageModalUrl: '',
                hostVncRunning: false,
                hostVncStatus: { x11vnc: false, novnc: false },

                get filteredResults() {
                    return this.reconResults.filter(r => {
                        if (this.filterField !== 'all' && r.field !== this.filterField) return false;
                        if (this.filterMethod !== 'all' && r.method !== this.filterMethod) return false;
                        if (this.filterKernel !== 'all' && r.kernel !== this.filterKernel) return false;
                        return true;
                    });
                },

                get hasComparisonHeatmap() {
                    return this.reconImages.some(i => i.name.includes('comparison') || i.name.includes('heatmap') || i.path.includes('comparison'));
                },

                get filteredImages() {
                    return this.reconImages.filter(img => {
                        if (img.name.includes('comparison') || img.name.includes('heatmap') || img.path.includes('comparison')) return false;
                        const parts = img.path.split('/');
                        if (parts.length < 4) return false;
                        const method = parts[0], field = parts[1], kernel = parts[2];
                        if (this.filterField !== 'all' && field !== this.filterField) return false;
                        if (this.filterMethod !== 'all' && method !== this.filterMethod) return false;
                        if (this.filterKernel !== 'all' && kernel !== this.filterKernel) return false;
                        return true;
                    });
                },

                init() {
                    this.connectWebSocket();
                    this.refreshStatus();
                    this.loadCompletedTrials().then(() => {
                        if (this.reconTrial) this.loadExistingResults();
                    });
                    this.checkHostVncStatus();
                },

                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
                    this.ws.onopen = () => { this.connected = true; };
                    this.ws.onclose = () => { this.connected = false; setTimeout(() => this.connectWebSocket(), 3000); };
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.containers) this.containers = data.containers;
                        if (data.system) this.system = data.system;
                    };
                },

                async refreshStatus() {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        this.containers = data.containers;
                        this.system = data.system;
                    } catch (e) { console.error(e); }
                },

                async loadCompletedTrials() {
                    try {
                        const response = await fetch('/api/trials/completed', { credentials: 'include' });
                        this.completedTrials = await response.json();
                        if (this.completedTrials.length > 0) this.reconTrial = this.completedTrials[0].id;
                        return this.completedTrials;
                    } catch (e) { return []; }
                },

                async startBatch() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/batch/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ start_trial: parseInt(this.batchStart), end_trial: parseInt(this.batchEnd), concurrent: parseInt(this.concurrent) })
                        });
                        const data = await response.json();
                        this.notify('success', `Started ${data.started.length} trials`);
                        this.refreshStatus();
                    } catch (e) { this.notify('error', 'Failed to start batch'); }
                    this.loading = false;
                },

                async startSingleTrial() {
                    const trialId = prompt('Enter trial number:');
                    if (trialId) {
                        try {
                            await fetch(`/api/trial/start/${trialId}`, { method: 'POST' });
                            this.notify('success', `Trial ${trialId} started`);
                            this.refreshStatus();
                        } catch (e) { this.notify('error', 'Failed to start trial'); }
                    }
                },

                async stopTrial(trialId) {
                    try {
                        await fetch(`/api/trial/stop/${trialId}`, { method: 'POST' });
                        this.notify('success', `Trial ${trialId} stopped`);
                        this.refreshStatus();
                    } catch (e) { this.notify('error', 'Failed to stop trial'); }
                },

                async removeTrial(trialId) {
                    try {
                        await fetch(`/api/trial/${trialId}`, { method: 'DELETE' });
                        this.notify('success', `Trial ${trialId} removed`);
                        this.refreshStatus();
                    } catch (e) { this.notify('error', 'Failed to remove trial'); }
                },

                getTrialVncUrl(trialId, vncPort) {
                    const hostname = window.location.hostname;
                    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.')) {
                        return `http://${hostname}:${vncPort}/vnc.html`;
                    }
                    return `https://trial${trialId}.${hostname}/vnc.html`;
                },

                getHostVncUrl() {
                    const hostname = window.location.hostname;
                    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.')) {
                        return `http://${hostname}:6080/vnc.html`;
                    }
                    return `https://vnc.${hostname}/vnc.html`;
                },

                async stopAll() {
                    if (confirm('Stop all running trials?')) {
                        try {
                            await fetch('/api/batch/stop', { method: 'POST' });
                            this.notify('success', 'All trials stopped');
                            this.refreshStatus();
                        } catch (e) { this.notify('error', 'Failed to stop trials'); }
                    }
                },

                runReconstruction(trialId) {
                    this.reconTrial = trialId;
                    this.currentTab = 'reconstruction';
                },

                async startReconstruction() {
                    this.reconRunning = true;
                    this.reconResults = [];
                    this.reconError = null;
                    try {
                        const response = await fetch(`/api/reconstruct/${this.reconTrial}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ field: 'all', method: 'all' })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.notify('info', `Reconstruction started for trial ${this.reconTrial}`);
                            this.pollReconstructionStatus();
                        } else {
                            this.notify('error', data.message || 'Failed');
                            this.reconRunning = false;
                        }
                    } catch (e) {
                        this.notify('error', 'Reconstruction failed');
                        this.reconRunning = false;
                    }
                },

                async pollReconstructionStatus() {
                    const poll = async () => {
                        try {
                            const response = await fetch(`/api/reconstruct/${this.reconTrial}/status`, { credentials: 'include' });
                            const data = await response.json();
                            if (data.running) {
                                setTimeout(poll, 2000);
                            } else {
                                if (data.success === false || data.return_code !== 0) {
                                    this.reconError = data.error || 'Failed';
                                    this.notify('error', 'Reconstruction failed');
                                    this.reconRunning = false;
                                } else {
                                    this.reconError = null;
                                    setTimeout(() => this.loadReconstructionResults(), 1000);
                                }
                            }
                        } catch (e) {
                            this.reconRunning = false;
                            this.reconError = 'Status check failed';
                        }
                    };
                    poll();
                },

                async loadReconstructionResults() {
                    try {
                        const response = await fetch(`/api/reconstruct/${this.reconTrial}/results`, { credentials: 'include' });
                        if (response.ok) {
                            const data = await response.json();
                            this.reconResults = data.results || [];
                        } else {
                            this.reconResults = [];
                        }
                        await this.loadReconstructionImages();
                        if (this.reconResults.length > 0) {
                            this.notify('success', `Loaded ${this.reconResults.length} results`);
                        }
                    } catch (e) {
                        this.notify('error', 'Failed to load results');
                        this.reconResults = [];
                        this.reconImages = [];
                    }
                    this.reconRunning = false;
                },

                async loadReconstructionImages() {
                    try {
                        const response = await fetch(`/api/reconstruct/${this.reconTrial}/images`, { credentials: 'include' });
                        if (response.ok) {
                            const data = await response.json();
                            this.reconImages = data.images || [];
                        } else {
                            this.reconImages = [];
                        }
                    } catch (e) {
                        this.reconImages = [];
                    }
                },

                async loadExistingResults() {
                    if (!this.reconTrial) return;
                    this.reconError = null;
                    try {
                        const response = await fetch(`/api/reconstruct/${this.reconTrial}/results`, { credentials: 'include' });
                        if (response.ok) {
                            const data = await response.json();
                            this.reconResults = data.results || [];
                        } else {
                            this.reconResults = [];
                        }
                        await this.loadReconstructionImages();
                    } catch (e) {
                        this.reconResults = [];
                        this.reconImages = [];
                    }
                },

                async generateComparisonHeatmap() {
                    if (this.reconResults.length === 0) return;
                    this.reconRunning = true;
                    try {
                        const response = await fetch(`/api/reconstruct/${this.reconTrial}/generate-heatmap`, { method: 'POST', credentials: 'include' });
                        const data = await response.json();
                        if (data.success) {
                            this.notify('success', 'Heatmap generated');
                            await this.loadReconstructionImages();
                        } else {
                            this.notify('error', 'Failed to generate heatmap');
                        }
                    } catch (e) {
                        this.notify('error', 'Failed to generate heatmap');
                    }
                    this.reconRunning = false;
                },

                showComparisonHeatmap() {
                    const heatmap = this.reconImages.find(i => i.name.includes('comparison') || i.name.includes('heatmap'));
                    if (heatmap) this.openImageModal(heatmap.url);
                },

                openImageModal(url) {
                    this.imageModalUrl = url;
                    this.imageModalOpen = true;
                },

                async deleteTrialData() {
                    if (!confirm(`Delete all data for trial ${this.reconTrial}?`)) return;
                    try {
                        const response = await fetch(`/api/trial/${this.reconTrial}/data`, { method: 'DELETE', credentials: 'include' });
                        const data = await response.json();
                        if (data.success) {
                            this.notify('success', 'Trial deleted');
                            this.reconResults = [];
                            this.reconImages = [];
                            this.reconError = null;
                            await this.loadCompletedTrials();
                            if (this.completedTrials.length > 0) {
                                this.reconTrial = this.completedTrials[0].id;
                                await this.loadExistingResults();
                            }
                        } else {
                            this.notify('error', 'Delete failed');
                        }
                    } catch (e) {
                        this.notify('error', 'Failed to delete');
                    }
                },

                async startHostVNC() {
                    try {
                        const response = await fetch('/api/host/vnc/start', { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            this.hostVncRunning = true;
                            this.notify('success', 'VNC started');
                        } else {
                            this.notify('error', 'Failed to start VNC');
                        }
                    } catch (e) { this.notify('error', 'Failed to start VNC'); }
                },

                async stopHostVNC() {
                    try {
                        await fetch('/api/host/vnc/stop', { method: 'POST' });
                        this.hostVncRunning = false;
                        this.notify('success', 'VNC stopped');
                    } catch (e) { this.notify('error', 'Failed to stop VNC'); }
                },

                async checkHostVncStatus() {
                    try {
                        const response = await fetch('/api/host/vnc/status');
                        const data = await response.json();
                        this.hostVncRunning = data.running;
                        this.hostVncStatus = { x11vnc: data.x11vnc_running || false, novnc: data.novnc_running || false };
                    } catch (e) {
                        this.hostVncRunning = false;
                        this.hostVncStatus = { x11vnc: false, novnc: false };
                    }
                },

                notify(type, message) {
                    this.notifications.push({ type, message });
                    setTimeout(() => this.notifications.shift(), 3000);
                },

                async logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        try {
                            await fetch('/api/logout', {
                                method: 'POST',
                                credentials: 'include'
                            });
                            window.location.href = '/login';
                        } catch (e) {
                            console.error('Logout failed:', e);
                            window.location.href = '/login';
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
